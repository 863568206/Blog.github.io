---
layout:     post
title:      （三十一）端口--汇编笔记
subtitle:   汇编语言
date:       2020-05-14
author:     YiMiTuMi
header-img: 
catalog: true
tags:
    - 汇编语言
---

## 端口

各种存储器都和CPU的地址线、数据线、控制线相连。CPU在控制它们的时候，把他们都当作内存来对待，把他们总地看做一个由若干存储单元组成的逻辑存储器，这个逻辑存储器我们称为内存地址空间。

在PC系统中，和CPU通过总线相连的芯片除各种存储器外，还有：

&emsp;1）各种接口卡（显卡、网卡等）上的接口芯片，它们控制接口卡进行工作。

&emsp;2）主板上的接口芯片，CPU通过它们对部分外设进行访问。

&emsp;3）其他芯片，用来存储相关的系统信息，或进行相关的输入输出处理。

这些芯片中，都有一组可以由CPU读写的寄存器。这些寄存器，它们在物理上可能处于不同的芯片中，但是它们在以下两点上相同：

&emsp;1）都和CPU的总线相连，当然这种连接是通过它们所在的芯片进行的。

&emsp;2）CPU对它们进行读或写的时候都通过控制线向它们所在的芯片发出端口读写命令。

从CPU的角度，将这些寄存器都当作端口，对它们进行统一编址，从而建立了一个统一的端口地址空间。每一个端口在地址空间中都有一个地址。

CPU可以直接读写以下3个地方的数据：

&emsp;1）CPU内部的寄存器

&emsp;2）内存单元

&emsp;3）端口（外部芯片的寄存器）

## 端口的读写

CPU通过端口地址来定位端口。因为端口所在的芯片和CPU通过总线相连，所以，端口地址和内存地址一样，通过地址总线来传送。在PC系统中，CPU最多可以定位64KB个不同的端口。则端口地址的范围为0 ~ 65535。

端口的读写指令只有两条：in 和 out，分别用于从端口读取数据和往端口写入数据。		
			
（1）访问内存

	mov ax, ds:[8]

执行时与总线相关的操作：

&emsp;1）CPU通过地址线将地址信息8发出

&emsp;2）CPU通过控制线发出内存读取命令，选中存储器芯片，并通知它，将要从中读取数据。

&emsp;3）寄存器将8号单元中的数据通过数据线送入CPU

（2）访问端口

&emsp;in al, 60H //从60h号端口读入1个字节

执行时与总线相关的操作：

&emsp;1）CPU通过地址线将地址信息60H发出

&emsp;2）CPU通过控制线发出端口读命令，选中端口所在的芯片，并通知它，将要从中读取数据

&emsp;3）端口所在的芯片将60H端口中的数据通过数据线送入CPU

注意，在 in 和 out指令中，只能使用ax或al来存放从端口中读入的数据或要发送到端口中的数据。访问8位端口时用al，访问16位端口时用ax。

对0 ~ 255以内的端口进行读写时：

	in al, 20h   //从20h端口读入一个字节
	
	out 20h, al  //往20h端口写入一个字节

对256 ~ 65535以内的端口进行读写时，端口号放在dx中：

	mov dx, 3f8H   //将端口号3f8h送入dx中
	
	in al, dx  //从3f8h端口读入一个字节
	
	out dx, al   //向3f8h端口写入一个字节


## CMOS RAM芯片

PC机中，有一个CMOS RAM芯片，一般简称位CMOS。特征：

&emsp;1）包含一个实时钟和一个有128个存储单元的RAM存储器（早期的计算机为64个字节）

&emsp;2）该芯片靠电池供电。所以，关机后其内部的实时钟仍可以正常工作，RAM中的信息不丢失。

&emsp;3）128个字节的RAM中，内部实时钟占用0 ~ 0dh单元来保存时间信息，其余大部分用于保存系统配置信息，供系统启动时BIOS程序读取。BIOS也提供了相关的程序，使我们可以在开机的时候配置CMOS RAM中的系统信息。

&emsp;4）该芯片内部有两个端口，端口地址为70h 和 71h。CPU通过这两个端口来读写CMOS RAM。

&emsp;5）70h 为地址端口，存放要访问的CMOS RAM单元的地址；71h为数据端口，存放从选定的CMOS RAM单元中读取的数据，或要写入到其中的数据。即CPU对CMOS RAM的读写分两步进行。

例：读CMOS RAM 的2号单元。

&emsp;1）将2送入端口70h

&emsp;2）从端口71h读取2号单元的内容。

	out 70h, 2
	
	in al, 71h

例2：向CMOS RAM的2号单元写入0

	out 70h, 2
	
	out 71h, 0

## CMOS RAM中存储的时间信息

在CMOS RAM中，存放着当前的时间：年、月、日、时、分、秒。这6个信息的长度都为1个字节，存放单元为：

	秒：0   分：2  时：4  日：7  月：8  年：9

这些数据以BCD码存放。一个字节可以表示两个BCD码。则CMOS RAM存储时间的单元中，存储了用两个BCD码表示的两位十进制数，高4位的BCD码表示十位，低4位的BCD码表示个位。

例：编程在屏幕中间显示当前的月份

&emsp;1）从CMOS RAM 的8号单元读出当前月份的BCD码。

	mov al, 8
	out 70h, al
	in al, 71h

&emsp;2）将用BCD码表示的月份以十进制的形式显示到屏幕上。

BCD码值 = 十进制数码值，则BCD码值 + 30h = 十进制数对应的ASCII码

&emsp;1）将从CMOS RAM的8号单元读出的一个字节，分为两个表示BCD码值的数据。

	mov ah, al    //al 从8号单元中读出的数据
	mov cl, 4
	shr ah, cl    //ah中为月份的十位数码值- 0000十位 这种格式
	and al, 00001111b //al中为月份的个位数码值 - 0000个位 格式

&emsp;2）显示（ah）+ 30h 和 （al）+ 30h 对应的ASCII码字符。

完成程序：

	assume cs:code
	
	code segment
	
		start:  mov al, 8
				out 70h, al
				in al, 71h
	
				mov ah, al
				mov cl, 4
				shr ah, cl
				and al, 00001111h
	
				add ah, 30H
				add al, 30H
	
				mov bx, 0b800h
				mov es, bx
				mov byte ptr es:[160 * 12 + 40 * 2], ah
				mov byte ptr es:[160 * 12 + 40 * 2 + 2], al
	
				mov ax, 4c00h
				int 21h
	
	code ends

	end start

## 白日菊 -- 永远的牵挂